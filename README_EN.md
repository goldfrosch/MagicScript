# MagicScript Plugin

MagicScript is a custom scripting language that is very similar to JavaScript syntax. This document describes the code structure of the plugin and the role of each module.

## Table of Contents

1. [Overview](#overview)
2. [Folder Structure](#folder-structure)
3. [Module Descriptions](#module-descriptions)
   - [Core](#core)
   - [Runtime](#runtime)
   - [Subsystem](#subsystem)
   - [Util](#util)
   - [Analysis](#analysis)
   - [Logging](#logging)
4. [Build Configuration](#build-configuration)

---

## Overview

MagicScript is a DSL (Domain Specific Language) with the following features:

- **Lexing and Parsing**: Tokenizes source code and converts it to an AST
- **Interpreter Execution**: Executes the AST to run scripts
- **Time/Space Complexity Analysis**: Calculates complexity through static and dynamic analysis
- **Async Support**: Handles asynchronous tasks like `setTimeout` through EventLoop
- **Native Function Integration**: Provides built-in functions written in C++

---

## Folder Structure

```
Plugins/MagicScript/
├── Source/
│   └── MagicScript/
│       ├── Core/               # Core compiler/interpreter components
│       ├── Runtime/            # Runtime execution environment
│       ├── Util/               # Built-in function collections
│       ├── Analysis/           # Complexity analyzer
│       ├── Logging/            # Logging system
│       ├── MagicScript.h       # Plugin module interface
│       ├── MagicScript.cpp
│       └── MagicScript.Build.cs # Build configuration
├── Content/                    # Plugin content
├── Resources/                  # Plugin resources
└── MagicScript.uplugin        # Plugin configuration file
```

---

## Module Descriptions

### Core

Core compiler and interpreter components.

#### `MsToken.h`

- **Role**: Defines token types and source location information
- **Key Contents**:
  - `ETokenType`: Token types generated by the lexer (Identifier, Number, String, keywords, operators, etc.)
  - `FSourceLocation`: Source code line/column position information
  - `FToken`: Token structure (type, lexeme, location information)

#### `MsLexer.h/cpp`

- **Role**: Lexer that converts source code into a token sequence
- **Key Features**:
  - Removes whitespace and comments
  - Recognizes numbers, strings, identifiers, keywords
  - Tokenizes operators and separators
  - Generates error tokens (for invalid characters, etc.)

#### `MsAst.h`

- **Role**: Defines Abstract Syntax Tree (AST) nodes
- **Key Structures**:
  - `FProgram`: Program root (array of statements)
  - `FStatement`: Statement nodes (blocks, variable declarations, function declarations, control statements, etc.)
  - `FExpression`: Expression nodes (binary/unary operations, literals, identifiers, calls, etc.)
  - Various statement/expression types (If, While, For, Switch, Call, etc.)

#### `MsParser.h/cpp`

- **Role**: Recursive descent parser that converts token sequences into an AST
- **Key Features**:
  - `ParseProgram()`: Parses entire program
  - Statement and expression parsing
  - Error recovery (synchronize)
  - Collects parsing error messages

#### `MsValue.h`

- **Role**: Defines runtime value types
- **Key Contents**:
  - `EValueType`: Value types (Null, Number, String, Bool, Function, Array, Object)
  - `FValue`: Runtime value structure (stores data by type)
  - `FFunctionValue`: Function value (distinguishes native/script functions)
  - Value creation helper functions (`FromNumber`, `FromString`, etc.)
  - `ToDebugString()`: String conversion for debugging

#### `MsEnvironment.h/cpp`

- **Role**: Manages variable scope and environment (lexical scope)
- **Key Features**:
  - `Define()`: Defines variables/functions
  - `Assign()`: Assigns variable values
  - `Lookup()`: Searches for variables (inherits from parent environment)
  - `Clone()`: Deep copies environment (for snapshots)

---

### Runtime

Runtime execution environment and interpreter.

#### `MsInterpreter.h/cpp`

- **Role**: Interpreter that executes AST
- **Key Features**:
  - `ExecuteProgram()`: Executes entire program
  - `ExecuteStatement()`: Executes statements
  - `EvaluateExpression()`: Evaluates expressions
  - `CallFunction()`: Calls functions (script/native)
  - Memory usage tracking (`PeakSpaceBytes`)
  - Execution statistics (execution count, expression evaluation count, function call count)
  - Recursive call depth limit (maximum 64)
  - `EExecutionMode`: Normal execution / Pre-analysis mode

#### `MsEventLoop.h/cpp`

- **Role**: Handles asynchronous tasks (e.g., `setTimeout`)
- **Key Features**:
  - `SetTimeout()`: Registers asynchronous tasks
  - `Tick()`: Called Tick to execute pending tasks
  - `HasPendingTasks()`: Checks if there are pending tasks
  - `ClearAllTasks()`: Cancels all tasks

---

### Util

Collections of native built-in functions.

#### `MsGlobalBuiltins.h/cpp`

- **Role**: Registers global native functions
- **Provided Functions**:
  - `SetGlobalFloat(name, value)`: Sets global variable

#### `MsArrayBuiltins.h/cpp`

- **Role**: Registers array-related native functions
- **Provided Functions**:
  - `Array.push_back(array, value)`: Adds element to end of array
  - `Array.push_front(array, value)`: Adds element to front of array
  - `Array.pop_back(array)`: Removes and returns last element of array
  - `Array.pop_front(array)`: Removes and returns first element of array
  - `Array.length(array)`: Returns array length

#### `MsConsoleBuiltins.h/cpp`

- **Role**: Registers console output-related native functions
- **Provided Functions**:
  - `console.log(...args)`: Outputs general log
  - `console.warn(...args)`: Outputs warning log
  - `console.error(...args)`: Outputs error log

#### `MsMathBuiltins.h/cpp`

- **Role**: Registers math functions
- **Provided Functions**:
  - `math.pow(base, exp)`: Calculates power

---

### Analysis

Complexity analyzer.

#### `MsTimeComplexity.h/cpp`

- **Role**: Analyzes script time complexity statically and dynamically
- **Key Contents**:
  - `FTimeComplexityResult`: Analysis result structure
    - `StaticComplexityScore`: Static complexity score based on AST
    - `DynamicExecutionCount`: Actual execution count
    - `StatementCount`: Number of statements
    - `MaxLoopDepth`: Maximum loop depth
    - `FunctionCallCount`: Number of function calls
    - `ExpressionEvaluationCount`: Number of expression evaluations
    - Analysis/execution time
  - `FTimeComplexityAnalyzer`: Traverses AST and calculates complexity

---

### Logging

Logging system.

#### `MsLogging.h`

- **Role**: Manages logs generated during script execution
- **Key Contents**:
  - `EScriptLogType`: Log types (Default, Warning, Error)
  - `FScriptLog`: Log structure (type, message)
  - `GetScriptLogs()`: Accesses global log array
  - `AddScriptLog()`: Adds log
  - `ClearScriptLogs()`: Clears logs

---

## Build Configuration

### MagicScript.Build.cs

Build configuration file for the plugin module. Includes necessary Unreal Engine modules and external libraries.

### MagicScript.uplugin

Plugin metadata:

- **Version**: 1.0
- **Name**: MagicScript
- **Type**: Runtime plugin
- **Creator**: GoldFrosch

---

## Usage

### Executing Scripts from C++

```cpp
#include "MagicScript/Subsystem/MagicScriptInterpreterSubsystem.h"

// Get subsystem
if (UMagicScriptInterpreterSubsystem* ScriptSubsystem = UMagicScriptInterpreterSubsystem::Get(this))
{
    // Execute script file
    bool bSuccess = ScriptSubsystem->RunScriptFile(
        TEXT("Scripts/MyScript.ms"),  // Relative path from Content folder
        TEXT("main")                   // Function name to execute
    );
}
```

### Receiving Logs

```cpp
// Bind delegate
ScriptSubsystem->OnScriptLogAdded.AddDynamic(this, &AMyActor::OnScriptLog);

// Callback function
void AMyActor::OnScriptLog(const FScriptLog& Log)
{
    UE_LOG(LogTemp, Log, TEXT("%s"), *Log.LogMessage);
}
```

### Updating Event Loop

The subsystem automatically calls `TickEventLoops()`, but it can also be called manually:

```cpp
ScriptSubsystem->TickEventLoops();
```

---

## Extending the Plugin

### Adding New Native Functions

1. Add function registration logic to the appropriate `Util` namespace file
2. Register function using `RegisterNative` lambda:

```cpp
RegisterNative(TEXT("MyFunction"), 0, [](const TArray<FValue>& Args, const FScriptExecutionContext& Context) -> FValue
{
    // Function implementation
    return FValue::FromNumber(42);
});
```

3. Call the namespace's `Register()` in `MagicScriptInterpreterSubsystem::OnRegisterBuiltins()`

---

## Notes

- All script code should be saved in `Content/Scripts/` folder with `.ms` extension
- Maximum function recursive call depth: 64
- Maximum while loop iterations: 128
- Script execution results are cached and reused
- Time/space complexity is automatically analyzed and cached

---
